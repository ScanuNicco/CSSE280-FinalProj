<!DOCTYPE html>
<html>
    <head>
        <title>Search | Indiana 211</title>
        <link rel="icon" href="slowlane.png"></link>
        <link rel="stylesheet" href="styles.css"></link>
        <link rel="stylesheet" href="search.css"></link>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""></link>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
	    <meta name="description" content="Search for a service.">
    </head>
    <body>
        <div id="countyBlocker">
            <div id="countiesListCont">
                <input id="countySearch" placeholder="Select a County" oninput="displayCounties()"></input>
                <div id="countiesList"></div>
            </div>
        </div>
        <div class="headerBar">
            <a href="/"><img src="logo.png"></a><div id="countyDisplay" onclick="displayCounties()">County</div>
        </div>
        <div id="outerFilterCont">
            <div id="viewSelector">
                <img class="active" src="home.svg" onclick="showView(0)">
                <img src="list.svg" onclick="showView(1)" class="">
                <img src="map.svg" onclick="showView(2)">
                <img id="filterButton" src="filter.svg" onclick="toggleFilter()">
            </div>
            <div id="filterCont" onclick="populateCurrentView()">
            <h2>Filter Results</h2>
            <div class="zipBox">
                <button><img src="location.svg"></button><input id="zipIn" placeholder="Zip Code" oninput="filterZip = this.value; populateCurrentView();">
            </div>
            <div class="filtersList" id="mainFilterList">
                <!-- <div class="filterRow">
                    <input type="checkBox">
                    <span>Food Bank</span>
                </div> -->
            </div>
            <button class="bigGlowyButton" onclick="resetFilter()">Reset</button>
        </div>
            <div id="rideViewsCont">
                <!-- <div id="homeCont">
                    <h2>Welcome to Indiana 2-1-1</h2>
                    <p>Are you looking for assistance with food, housing, or child care? You can use this helpful tool to narrow your search.</p>
                    <img class="welcomeImg" src="lady-holding-baby.jpg" alt="Lady Holding a Baby">
                </div>
                <div id="listCont"></div>
                <div id="mapCont">
                    <div id="map"></div> -->
                    <div id="homeCont">
                    <section class="hero" id="welcomeTop" style="margin: 10px 50px;">
                        <div class="intro-text">
                          <h1>
                            <span class="2-1-1">Welcome To</span><br>
                            <span class="welcome">Indiana 211</span> <br />
                          </h1>
                          <p>
                            Are you looking for assistance with food, housing, or child care? You can use this helpful tool to turbocharge your search
                          </p>
    
                        </div>
                        <img class="welcomeImg" src="lady-holding-baby.jpg" alt="Lady Holding a Baby">
                      </section>
                      <section class="hero">
                        <div class="tipIcon">
                            <img src="homepage_findmap.svg">
                        </div>
                        <div class="intro-text">
                            <h2>Find Assistance Near Your Location</h2>
                            <span>Indiana 211 can help you find assistance in your community. Use the map view on this website to see what is available near you!</span><br>
                            <button class="smolGlowyButton" onclick="showView(2)">Open Map View</button>
                        </div>
                      </section>
                      <section class="hero">
                        <div class="tipIcon">
                            <img src="homepage_findlist.svg" style="background: rgb(190, 223, 185)">
                        </div>
                        <div class="intro-text">
                            <h2>Print a List of Resources</h2>
                            <span>You can use the list view to print out a list of resources for you to use.</span><br>
                            <button class="smolGlowyButton"  onclick="showView(1)">Open List View</button>
                        </div>
                      </section>
                      <section class="hero">
                        <div class="tipIcon">
                            <img src="homepage_filter.svg"  style="background: rgb(190, 185, 223);">
                        </div>
                        <div class="intro-text">
                            <h2>Refine you Search</h2>
                            <span>Use filters to narrow your results to specific locations or categories.</span><br>
                            <button class="smolGlowyButton" onclick="showView(2); toggleFilter();">Open Filters</button>
                        </div>
                      </section>
                    </div>
                      <div id="listCont">
                        <div class="topActionRow">
                            <button class="smolGlowyButton">Print Results</button>
                        </div>
                        <div id="rowsCont">
                        </div>
                      </div>
                      <div id="mapCont">
                          <div id="map"></div> 
                </div>
            </div>
        <div id="modalBackground">
            <button id="close" onclick="closeModal()">&times;</button>
            <div id="modal">
                <h1 id="infoModalHeader">Ride Request for ___</h1>
                <div id="statusBox">
                    <div id="statusLabel">Status:</div>
                    <div id="statusContent"></div>
                </div>
                <table>
                    <tr><td class="label">Address:</td><td id="addr"></td></tr>
                    <tr><td class="label">Category:</td><td id="cat"></td></tr>
                    <tr><td class="label">Description:</td><td id="desc"></td></tr>
                    <tr><td class="label">Contact:</td><td id="contact"></td></tr>
                    <tr><td class="label">Operating Hours:</td><td id="hours"></td></tr>
                    <tr><td class="label">Target Group:</td><td id="elgibility"></td></tr>
                </table>
                <a id="gmLink">
                    <button class="bigGlowyButton">Directions</button>
                </a>
            </div>
        </div>
        <script src="/fullcalendar/dist/index.global.min.js"></script>
        <script src="shared.js"></script>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/OverlappingMarkerSpiderfier-Leaflet/0.2.6/oms.min.js"></script>
        <script>
                const RESOURCES_URL = "realResources.json";
                const COUNTIES_LIST_URL = "countyList.json";

                var q;
                var resources = [];
                var map;
                var mlg;
                var oms;
                var cats = {};
                var filterZip = "";
                var counties;

                window.onload = async function() {
                    await fetchCounties();

                    //Populate categories and results
                    html = "";

                    map = L.map('map').setView([39.48292, -88], 7);
                    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 20,
                        attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                        detectRetina: true
                    }).addTo(map);

                    mlg = L.layerGroup().addTo(map);

                    oms = new OverlappingMarkerSpiderfier(map);
                    oms.addListener('click', showResFromMarker);

                    resetFilter();
                    displayResources(generateHTML);
                }

                async function fetchCounties() {
                    var response = await fetch(COUNTIES_LIST_URL);
                    counties = await response.json();
                    displayCounties();
                }

                function displayCounties() {
                    document.getElementById("countyBlocker").style.display = "flex";
                    var query = document.getElementById("countySearch").value;
                    var html = "";
                    for(county in counties) {
                        if(query.length <= 0 || county.toLowerCase().includes(query.toLowerCase())) {
                            html += `<div class='county' onclick='selectCounty("${county}")'>${county}</div>`;
                        }
                    }
                    document.getElementById("countiesList").innerHTML = html;
                }

                async function selectCounty(county) {
                    var response = await fetch(counties[county]);
                    resources = await response.json();
                    genCats();
                    resetFilter();
                    document.getElementById("countyBlocker").style.display = "none";
                    document.getElementById("countyDisplay").innerText = county;
                }

                var listHTML;
                function showList() {
                    console.log("Hello");
                    listHTML = "";
                    displayResources(generateHTML);
                    if(listHTML == ""){ //There were no rides
                            listHTML = "<div id='lhCont'><img src='noRides.svg' class='lighthouse'></img></div>";
                    }
                    document.getElementById("rowsCont").innerHTML = listHTML;
                    console.log("Hello");
                }

                function generateHTML(ind, res) {
                    listHTML += `<div class='resourceRow' onclick="showDetails(${ind})"><div id="leftCol"><h3>${formatNames(resources[ind].agency_name)}</h3><span class='listLoc'>${res.city}</span></div></div>`;
                }

                function displayResources(handler) {
                    for(var ind = 0; ind < resources.length; ind++) {
                        if(passesFilters(resources[ind]) && ind < 1500){
                            handler(ind, resources[ind]);
                        }
                    }
                }

                function formatNames(string) {
                    var words = string.split(" ");
                    for(i in words) {
                        var word = words[i];
                        word = word.toLowerCase();
                        word = word.charAt(0).toUpperCase() + word.substring(1);
                        words[i] = word;
                    }
                    string = words.join(" ");
                    if(string.length > 50) {
                        return string.substring(0, 22) + "...";
                    }
                    return string;
                }

                function passesFilters(res) {
                    return cats[res.taxonomy_category].enabled && (res.zipcode == filterZip || filterZip.length != 5);
                }

                function showDetails(res) {
                    var r = resources[res];
                    document.getElementById("infoModalHeader").innerText = r.agency_name;
                    var addrString  = `${r.address_1} ${r.address_2 ?? ""}, ${r.city} ${r.state_province}, ${r.zipcode}`;
                    if(r.city.length <= 0|| r.state_province.length <= 0 || r.address_1.length < 0) {
                        addrString = "N/A";
                        document.getElementById("gmLink").style.display = "none";
                    } else {
                        document.getElementById("gmLink").style.display = "initial";
                    }
                    document.getElementById("addr").innerText = addrString;
                    document.getElementById("cat").innerText = r.taxonomy_category;
                    document.getElementById("desc").innerText = r.agency_desc;
                    document.getElementById("contact").innerHTML = (r.service_website != null && r.service_website.length > 0 ? `<a href="${r.service_website}">${r.service_website}</a><br>` : "") + (r.service_email != null && r.service_email.length > 0 ? `<a href="mailto:${r.service_email}">${r.service_email}</a><br>` : "") + (r.site_number && r.site_number.length > 0 != null ? r.site_number : "");
                    document.getElementById("gmLink").href = `https://www.google.com/maps/place/${addrString}`;
                    document.getElementById("hours").innerText = r.site_schedule;
                    document.getElementById("elgibility").innerText = r.site_eligibility ?? "All";
                    openModal();
                }

                function closeModal() {
                    document.getElementById("modalBackground").style.top = "100vh";
                    document.getElementById("modalBackground").style.borderRadius = "100px";
                }

                function openModal() {
                    document.getElementById("modalBackground").style.top = "0vh";
                    document.getElementById("modalBackground").style.borderRadius = "0px";
                }

                function resetFilter() {
                    var boxes = document.getElementById("mainFilterList").querySelectorAll("input[type=checkbox]"); 
                    for(box in boxes) {
                        boxes[box].checked = true;
                    }
                    for(cat in cats) {
                        cats[cat].enabled = true;
                    }
                    populateCurrentView();
                }

                var views = [{id: "homeCont", setup: showHome}, {id: "listCont", setup: showList}, {id: "mapCont", setup: showMap}]; //Add view IDs to this list in the order the appear in the selector
                var currentView = 0;
                function showView(id) {
                    var viewSelectCont = document.getElementById("viewSelector");
                    for(var i = 0; i < views.length; i++){
                        document.getElementById(views[i].id).style.display = "none";
                        viewSelectCont.children[i].classList.remove("active");
                    }
                    document.getElementById(views[id].id).style.display = "block";
                    viewSelectCont.children[id].classList.add("active");
                    views[id].setup();
                    currentView = id;
                }

                function populateCurrentView() {
                    views[currentView].setup();
                }

                function showMap() {
                    map.invalidateSize();
                    oms.clearMarkers();
                    mlg.clearLayers();
                    displayResources(mapGenerator);
                }

                function mapGenerator(ind, res) {
                    if(res.latitude != null && res.longitude != null){
                        var coords = [res.latitude, res.longitude];
                        var marker = L.marker(coords).addTo(mlg);
                        marker.resInd = ind;
                        marker._icon.style.filter = `hue-rotate(${cats[res.taxonomy_category].hue - 210}deg)`;
                        oms.addMarker(marker);
                    }
                }

                function showResFromMarker(marker){
                    showDetails(marker.resInd);
                }

                function toggleFilter() {
                    var filterCont = document.getElementById("filterCont");
                    var filterButton = document.getElementById("filterButton");
                    if(filterCont.style.display != "flex"){
                        filterCont.style.display = "flex"
                        filterButton.classList.add("active");
                    } else {
                        filterCont.style.display = "none"
                        filterButton.classList.remove("active");
                    }
                }

                function showHome() {

                }

                function genCats() {
                    for(resource of resources) {
                        if(!cats.hasOwnProperty(resource.taxonomy_category)){
                            cats[resource.taxonomy_category] = {taxonCode: resource.taxonomy_code};
                        }
                    }
                    //Now we know how many there are
                    var numCats = Object.keys(cats).length;
                    var colorJump = 360/numCats;
                    var html = "";
                    for(var i = 0; i < numCats; i++) {
                        var cat = Object.keys(cats)[i];
                        cats[cat].color = `hsl(${i*colorJump}, 62%, 60.8%)`;
                        cats[cat].hue = i*colorJump;
                        html += `<div class="filterRow">
                                    <input type="checkBox" style="--ck-inactive-color: hsl(${i*colorJump}, 20%, 50%); --ck-active-color: hsl(${i*colorJump}, 62%, 60.8%);" onclick="toggleCategory(this, '${cat}')">
                                    <span>${cat}</span>
                                </div>`;
                    }
                    document.getElementById("mainFilterList").innerHTML = html;
                }

                function toggleCategory(elem, cat) {
                    cats[cat].enabled = elem.checked;
                    populateCurrentView();
                }
            </script>
        </body>
    </html>
